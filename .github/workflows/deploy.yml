name: Deploy marimo app to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›ï¸ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install marimo
        pip install pandas
        pip install numpy
        pip install scipy
        pip install zarr
        pip install matplotlib
        pip install seaborn
        pip install h5py
        pip install numexpr
        pip install scikit-allel
        # Verify scikit-allel installation
        python -c "import allel; print('scikit-allel version:', allel.__version__)"
    
    - name: ğŸ“„ Export notebook as static HTML
      run: |
        marimo export html AIM_app.py -o ./dist
    
    - name: ğŸ“ Add .nojekyll file
      run: touch ./dist/.nojekyll
    
    - name: ğŸ“¦ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸŒ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4